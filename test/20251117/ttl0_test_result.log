
[1m[96m================================================================================[0m
[1m[96m                                  TTL=0 修复验证测试                                  [0m
[1m[96m================================================================================[0m


[1m[96m================================================================================[0m
[1m[96m                                  阶段 1: 准备测试环境                                  [0m
[1m[96m================================================================================[0m

[1m[94m[步骤] 清空 RouterOS 地址列表: gfw_ip[0m
  列表 gfw_ip 已经是空的

[1m[96m================================================================================[0m
[1m[96m                                阶段 2: 启动 CoreDNS                                [0m
[1m[96m================================================================================[0m

[1m[94m[步骤] 启动 CoreDNS[0m
[92m✓ CoreDNS 已启动 (PID: 50596)[0m

[1m[96m================================================================================[0m
[1m[96m                               阶段 3: 重复查询测试（关键测试）                               [0m
[1m[96m================================================================================[0m

  测试说明:
    - 将重复查询 www.google.com 10 次
    - TTL=0 的列表应该:
      ✓ 第1次: 添加到 RouterOS 并缓存
      ✓ 第2-10次: 缓存命中，跳过添加
      ✗ 不应该出现 400 Bad Request 错误
  
[1m[94m[步骤] 重复查询域名 www.google.com 10 次[0m
  
第 1 次查询 www.google.com...
[92m✓ 解析成功: 31.13.94.37[0m
  
第 2 次查询 www.google.com...
[92m✓ 解析成功: 31.13.94.37[0m
  
第 3 次查询 www.google.com...
[92m✓ 解析成功: 199.16.158.12[0m
  RouterOS 中有 2 个地址:
    - 31.13.94.37          (ID: *782, 永不过期 (TTL=0))
    - 199.16.158.12        (ID: *783, 永不过期 (TTL=0))
[91m✗ ✗ 数量异常: 期望 1 个，实际 2 个（可能有重复添加）[0m
  
第 4 次查询 www.google.com...
[92m✓ 解析成功: 31.13.94.49[0m
  
第 5 次查询 www.google.com...
[92m✓ 解析成功: 157.240.17.35[0m
  
第 6 次查询 www.google.com...
[92m✓ 解析成功: 199.16.158.8[0m
  RouterOS 中有 5 个地址:
    - 31.13.94.37          (ID: *782, 永不过期 (TTL=0))
    - 199.16.158.12        (ID: *783, 永不过期 (TTL=0))
    - 31.13.94.49          (ID: *784, 永不过期 (TTL=0))
    - 157.240.17.35        (ID: *785, 永不过期 (TTL=0))
    - 199.16.158.8         (ID: *786, 永不过期 (TTL=0))
[91m✗ ✗ 数量异常: 期望 1 个，实际 5 个（可能有重复添加）[0m
  
第 7 次查询 www.google.com...
[92m✓ 解析成功: 31.13.73.9[0m
  
第 8 次查询 www.google.com...
[92m✓ 解析成功: 31.13.68.169[0m
  
第 9 次查询 www.google.com...
[92m✓ 解析成功: 199.59.148.20[0m
  RouterOS 中有 8 个地址:
    - 31.13.94.37          (ID: *782, 永不过期 (TTL=0))
    - 199.16.158.12        (ID: *783, 永不过期 (TTL=0))
    - 31.13.94.49          (ID: *784, 永不过期 (TTL=0))
    - 157.240.17.35        (ID: *785, 永不过期 (TTL=0))
    - 199.16.158.8         (ID: *786, 永不过期 (TTL=0))
    - 31.13.73.9           (ID: *787, 永不过期 (TTL=0))
    - 31.13.68.169         (ID: *788, 永不过期 (TTL=0))
    - 199.59.148.20        (ID: *789, 永不过期 (TTL=0))
[91m✗ ✗ 数量异常: 期望 1 个，实际 8 个（可能有重复添加）[0m
  
第 10 次查询 www.google.com...
[92m✓ 解析成功: 31.13.73.169[0m

[1m[96m================================================================================[0m
[1m[96m                                  阶段 4: 验证测试结果                                  [0m
[1m[96m================================================================================[0m

[1m[94m[步骤] 检查 RouterOS 最终状态[0m
  RouterOS 中有 9 个地址:
    - 31.13.94.37          (ID: *782, 永不过期 (TTL=0))
    - 199.16.158.12        (ID: *783, 永不过期 (TTL=0))
    - 31.13.94.49          (ID: *784, 永不过期 (TTL=0))
    - 157.240.17.35        (ID: *785, 永不过期 (TTL=0))
    - 199.16.158.8         (ID: *786, 永不过期 (TTL=0))
    - 31.13.73.9           (ID: *787, 永不过期 (TTL=0))
    - 31.13.68.169         (ID: *788, 永不过期 (TTL=0))
    - 199.59.148.20        (ID: *789, 永不过期 (TTL=0))
    - 31.13.73.169         (ID: *78A, 永不过期 (TTL=0))
[91m✗ ✗ 数量异常: 期望 1 个，实际 9 个（可能有重复添加）[0m
[1m[94m[步骤] 分析 CoreDNS 日志（最近 1 秒）[0m
  
关键日志:
  
日志统计:
    - 缓存命中/跳过: 0 次
    - 添加到缓存: 0 次
    - 400 错误: 0 次
[93m⚠ 
⚠️  缓存命中次数较少，可能需要更多测试[0m

[1m[96m================================================================================[0m
[1m[96m                                      测试总结                                      [0m
[1m[96m================================================================================[0m

  查询统计:
    - 总查询次数: 10
    - 成功次数: 10
    - 失败次数: 0
  
RouterOS 条目:
    - 期望数量: 1
    - 实际数量: 9
[91m✗ 
================================================================================[0m
[91m✗ ✗✗✗ 测试失败！发现问题：[0m
[91m✗ ================================================================================[0m
[91m✗   ✗ RouterOS 中有重复条目[0m
[1m[94m[步骤] 停止 CoreDNS[0m
[92m✓ CoreDNS 已停止[0m
